### 직접 해보는 JPA 2

### 1. 객체는 참조를 사용해서 관계를 맺는다
```
create table line (
    id bigint generated by default as identity,
    name varchar(255) not null,
    primary key (id)
)

create table station (
    id bigint generated by default as identity,
    name varchar(255) not null,
    line_id bigint,
    primary key (id)
)

alter table station 
    add constraint FKklalypfiiahjy57wtapf4w92 
    foreign key (line_id) 
    references line
```

### 2. 모든 엔티티는 영속화된 상태여야 한다
```
@Test
void saveWithLine() {
    Station expected = new Station("잠실역");
    expected.setLine(new Line("2호선"));
    Station actual = stations.save(expected);
    stations.flush(); // transaction commit
}
```

### 3. 객체는 자유롭게 객체 그래프를 탐색할 수 있어야 한다
```
@Test
void findByNameWithLine() {
    Station actual = stations.findByName("교대역");
    assertThat(actual).isNotNull();
    assertThat(actual.getLine().getName()).isEqualTo("3호선");
}
```

### 4. 한 트랜잭션 안에서 발생하는 엔티티의 변경사항을 감지한다
```
@Test
void updateWithLine() {
    Station expected = stations.findByName("교대역");
    expected.setLine(lines.save(new Line("2호선")));
    stations.flush(); // transaction commit
}
```

### 5. 참조에 NULL을 사용하면 연관된 엔티티를 삭제할 수 있다
```
@Test
void removeLine() {
    Station expected = stations.findByName("교대역");
    expected.setLine(null);
    stations.flush(); // transaction commit
}
```

### 6. 객체를 양방향으로 참조하려면 단방향 연관관계를 2개 만들어야 한다
```
@Test
void findByName() {
    Line line = lines.findByName("3호선");
    assertThat(line.getStations()).hasSize(1);
}
```

### 7. 연관 관계의 주인만이 외래 키를 등록, 수정, 삭제할 수 있다
```
@Test
void save() {
    Line expected = new Line("2호선");
    expected.addStation(stations.save(new Station("잠실역")));
    lines.save(expected);
    lines.flush(); // transaction commit
}
```

### 8. @JoinColumn 어노테이션은 연관 관계에 따라서 작동하는 방식이 달라진다 
```
create table favorite (
    id bigint generated by default as identity,
    member_id bigint,
    primary key (id)
)

create table member (
    id bigint generated by default as identity,
    name varchar(255),
    primary key (id)
)

alter table favorite 
   add constraint FK5w3q9ljpthkixo71hetx3ired 
   foreign key (member_id) 
   references member
```

### 9. 연관 관계 처리를 위한 UPDATE SQL을 추가로 실행해야 한다
```
@Test
void save() {
    Member expected = new Member("jason");
    expected.addFavorite(favorites.save(new Favorite()));
    Member actual = members.save(expected);
    members.flush(); // transaction commit
}
```

### 10. 외래 키를 가지고 있는 테이블만 확인해도 대상 테이블과 연관 관계가 있는지 알 수 있다
```
create table line_station (
    id bigint generated by default as identity,
    line_id bigint,
    primary key (id)
)

create table station (
    id bigint generated by default as identity,
    name varchar(255) not null,
    line_station_id bigint,
    primary key (id)
)

alter table station 
   add constraint FKtkxivxas996j9c54ngcd0bby2 
   foreign key (line_station_id) 
   references line_station
```

### 11. INSERT 이외에 불필요한 SQL이 발생하지 않는다 
```
@Test
void saveWithLineStation() {
    LineStation lineStation = lineStations.save(new LineStation());
    stations.save(new Station("잠실역", lineStation));
}
```

### 12. 환승역을 고려했을 때 대상 테이블에 외래 키를 부여할 수 있다
```
create table line_station (
    id bigint generated by default as identity,
    line_id bigint,
    station_id bigint,
    primary key (id)
)

create table station (
    id bigint generated by default as identity,
    name varchar(255) not null,
    primary key (id)
)

alter table line_station 
    add constraint FK78y8i0a0kum6n7s2qss4wi6i9 
    foreign key (station_id) 
    references station
```