# JPA HandsOn

## ğŸš€ 1ë‹¨ê³„ - ì—”í‹°í‹° ë§¤í•‘

### Goal

QnA ì„œë¹„ìŠ¤ë¥¼ ë§Œë“¤ì–´ê°€ë©´ì„œ JPAë¡œ ì‹¤ì œ ë„ë©”ì¸ ëª¨ë¸ì„ ì–´ë–»ê²Œ êµ¬ì„±í•˜ê³  ê°ì²´ì™€ í…Œì´ë¸”ì„ ì–´ë–»ê²Œ ë§¤í•‘í•´ì•¼ í•˜ëŠ”ì§€ ì•Œì•„ë³¸ë‹¤.

### Requirements

* ì•„ë˜ì˜ DDL(Data Definition Language)ì„ ë³´ê³  ìœ ì¶”í•˜ì—¬ ì—”í‹°í‹° í´ë˜ìŠ¤ì™€ ë¦¬í¬ì§€í† ë¦¬ í´ë˜ìŠ¤ë¥¼ ì‘ì„±í•´ ë³¸ë‹¤.
* @DataJpaTestë¥¼ ì‚¬ìš©í•˜ì—¬ í•™ìŠµ í…ŒìŠ¤íŠ¸ë¥¼ í•´ ë³¸ë‹¤.

```sql
create table answer
(
    id          bigint generated by default as identity,
    contents    clob,
    created_at  timestamp not null,
    deleted     boolean   not null,
    question_id bigint,
    updated_at  timestamp,
    writer_id   bigint,
    primary key (id)
)

create table delete_history
(
    id            bigint generated by default as identity,
    content_id    bigint,
    content_type  varchar(255),
    create_date   timestamp,
    deleted_by_id bigint,
    primary key (id)
)

create table question
(
    id         bigint generated by default as identity,
    contents   clob,
    created_at timestamp    not null,
    deleted    boolean      not null,
    title      varchar(100) not null,
    updated_at timestamp,
    writer_id  bigint,
    primary key (id)
)

create table user
(
    id         bigint generated by default as identity,
    created_at timestamp   not null,
    email      varchar(50),
    name       varchar(20) not null,
    password   varchar(20) not null,
    updated_at timestamp,
    user_id    varchar(20) not null,
    primary key (id)
)

alter table user
    add constraint UK_a3imlf41l37utmxiquukk8ajc unique (user_id)


```

### TODO
- [x] JPA Auditing Entity
- [x] Enable JPA Audit in Application 
- [x] Answer Entity
- [x] Answer Test (CRUD)
- [x] DeleteHistory Entity
- [ ] ~~DeleteHistory Test(CRUD)~~
- [x] Question Entity
- [x] Question Test(CRUD)
- [x] User Entity
	- [x] ìŠ¤í‚¤ë§ˆì— ë§ê²Œ ì–´ë…¸í…Œì´ì…˜ ì¶”ê°€
	- [x] ë¶ˆí•„ìš”í•œ setter ì‚­ì œ
	- [x] equals / hashCode ì¶”ê°€
		- [x] core fields = id, userId
- [x] User Entity Test (CRUD)

### Hints

Spring Data JPA ì‚¬ìš© ì‹œ ì•„ë˜ ì˜µì…˜ì€ ë™ì‘ ì¿¼ë¦¬ë¥¼ ë¡œê·¸ë¡œ í™•ì¸í•  ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤.

```
spring.jpa.properties.hibernate.format_sql=true
spring.jpa.show-sql=true
```

## ğŸš€ 2ë‹¨ê³„ - ì—°ê´€ ê´€ê³„ ë§¤í•‘

### Requirement

ê°ì²´ì˜ ì°¸ì¡°ì™€ í…Œì´ë¸”ì˜ ì™¸ë˜ í‚¤ë¥¼ ë§¤í•‘í•´ì„œ, ê°ì²´ì—ì„œëŠ” ì°¸ì¡°ë¥¼ ì‚¬ìš©í•˜ê³  í…Œì´ë¸”ì—ì„œëŠ” ì™¸ë˜ í‚¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤.

### Hints

ì•„ë˜ì˜ DDLì„ ë³´ê³  ìœ ì¶”í•œë‹¤.

```sql
alter table answer
    add constraint fk_answer_to_question
        foreign key (question_id)
            references question

alter table answer
    add constraint fk_answer_writer
        foreign key (writer_id)
            references user

alter table delete_history
    add constraint fk_delete_history_to_user
        foreign key (deleted_by_id)
            references user

alter table question
    add constraint fk_question_writer
        foreign key (writer_id)
            references user

```

### TODO
- [x] Apply Step1 Feedback
	- [x] Renameing TestClass Names to XXRepoTest
- [x] Question entity ìˆ˜ì •
- [x] QuestionRepositoryTestìˆ˜ì •
- [x] DeleteHistory Entityìˆ˜ì •
- [x] Answer entity ìˆ˜ì •
- [x] Answer Repository  Testìˆ˜ì •
	- [x] ìƒˆë¡œ ì¶”ê°€í•œ ë©”ì„œë“œë‘ í…ŒìŠ¤íŠ¸
- [x] User Repository Testìˆ˜ì •
- [x] (Optional) í•„ìš”í•˜ë‹¤ë©´ í•´ë‹¹ ServiceCode , Testìˆ˜ì •
- [x] (Optional) FK ë¶™ì´ê¸°

- [x] TestFixtureê³ ì¹˜ê¸°
	- [x] JPA í…ŒìŠ¤íŠ¸ì—ì„œ í…ŒìŠ¤íŠ¸ ëŒ€ìƒì„ staticìœ¼ë¡œ ë§Œë“¤ì–´ë†“ê³  ì¬ì‚¬ìš©í•˜ê²Œ ë˜ë©´ ì—¬ëŸ¬ê°€ì§€ ë¬¸ì œê°€ ë  ê²ƒì„ ê³ ë ¤í•˜ì—¬,  ì»¨í…ìŠ¤íŠ¸ ê²©ë¦¬ë¥¼ ê³ ë ¤í•œ í…ŒìŠ¤íŠ¸ í”½ìŠ¤ì²˜ ì‘ì„±

- [x] QnAì„œë¹„ìŠ¤ìˆ˜ì •
- [x] QnAì„œë¹„ìŠ¤í…ŒìŠ¤íŠ¸ê°€ ì˜í–¥ì—†ëŠ” ê²ƒ í™•ì¸

- [x] ë”ì´ìƒ ì“°ì´ì§€ ì•ŠëŠ” ì½”ë“œë“¤ + í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‚­ì œ(ì•„ì´ë””ê´€ë ¨í•œ ë©”ì„œë“œë“¤)

- [x] DB ìŠ¤í‚¤ë§ˆëŠ” ë³€ê²½ ì•ˆëœ ê²ƒ í™•ì¸

---
### ê³ ë ¤ì‚¬í•­
- [x] ë¨¼ì € ë‹¨ë°©í–¥ìœ¼ë¡œ ì„¤ê³„ ëë‚´ê¸°
- LAZYì˜ ì´ì ê³¼, ê³ ë ¤í• ì  ì„ í™•ì¸í•˜ê¸°ê¹Œì§€ëŠ”,  LAZYê±¸ì§€ ì•Šê³  ì„¤ê³„í•˜ê¸°.
- êµ³ì´ ì–‘ë°©í–¥ìœ¼ë¡œ ë§Œë“¤ í•„ìš” ìˆë‚˜ ëª¨ë“  ì„¤ê³„ ëë‚˜ê³  ì¬ í™•ì¸
	- í•„ìš”í•˜ë‹¤ë©´ í¸ì˜ ë©”ì„œë“œ ë§Œë“¤ê¸° for Testing
	- ë¬´í•œë£¨í”„ ê°€ëŠ¥ì„± ì²´í¬í•˜ê¸°(toString(), lombok, JSONìƒì„±)

---
## ğŸš€ 3ë‹¨ê³„ - ì§ˆë¬¸ ì‚­ì œí•˜ê¸° ë¦¬íŒ©í„°ë§
### ê¸°ëŠ¥ ìš”êµ¬ì‚¬í•­
- ì§ˆë¬¸ ì‚­ì œ OK ì¼€ì´ìŠ¤ :
	- ë‹µë³€ì´ ì—†ëŠ” ê²½ìš°
	- ë¡œê·¸ì¸ ì‚¬ìš©ìì™€ ì§ˆë¬¸í•œ ì‚¬ëŒì´ ê°™ì€ ê²½ìš°
	- ì§ˆë¬¸ìì™€ ë‹µë³€ê¸€ì˜ ëª¨ë“ ë‹µë³€ì ê°™ì€ê²½ìš°
- ì§ˆë¬¸ ì‚­ì œ NG ì¼€ì´ìŠ¤ :
	- ë¡œê·¸ì¸ ì‚¬ìš©ìì™€ ì§ˆë¬¸í•œ ì‚¬ëŒì´ ë‹¤ë¥¸ ê²½ìš°.
	- ì§ˆë¬¸ìì™€ ë‹µë³€ê¸€ì˜ ëª¨ë“  ë‹µë³€ì ì¤‘, í•œ ì‚¬ëŒì´ë¼ë„ ë‹¤ë¥¸ ìœ ì €ê°€ ì“´ ë‹µë³€ì´ ì¡´ì¬í•˜ëŠ” ê²½ìš°
- ì§ˆë¬¸ ì‚­ì œì‹œ Behavior :
	- ì§ˆë¬¸ Soft-delete (ë°ì´í„°ì˜ ìƒíƒœë¥¼ ì‚­ì œ ìƒíƒœ(deleted - boolean type)ë¡œ ë³€ê²½)
	- ë‹µë³€ ë˜í•œ soft delete
	- ì§ˆë¬¸ê³¼ ë‹µë³€ ì‚­ì œ ì´ë ¥ì— ëŒ€í•œ ì •ë³´ë¥¼ DeleteHistory insert
### í”„ë¡œê·¸ë˜ë° ìš”êµ¬ì‚¬í•­
- qna.service.QnaServiceì˜ deleteQuestion()ëŠ” ì•ì˜ ì§ˆë¬¸ ì‚­ì œ ê¸°ëŠ¥ì„ êµ¬í˜„í•œ ì½”ë“œì´ë‹¤. ì´ ë©”ì†Œë“œëŠ” ë‹¨ìœ„ í…ŒìŠ¤íŠ¸í•˜ê¸° ì–´ë ¤ìš´ ì½”ë“œì™€ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•œ ì½”ë“œê°€ ì„ì—¬ ìˆë‹¤.
- ë‹¨ìœ„ í…ŒìŠ¤íŠ¸í•˜ê¸° ì–´ë ¤ìš´ ì½”ë“œì™€ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•œ ì½”ë“œë¥¼ ë¶„ë¦¬í•´ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•œ ì½”ë“œ ì— ëŒ€í•´ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ êµ¬í˜„í•œë‹¤.
```java
public class QnAService {
    public void deleteQuestion(User loginUser, long questionId) throws CannotDeleteException {
        Question question = findQuestionById(questionId);
        if (!question.isOwner(loginUser)) {
            throw new CannotDeleteException("ì§ˆë¬¸ì„ ì‚­ì œí•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
        }

        List<Answer> answers = question.getAnswers();
        for (Answer answer : answers) {
            if (!answer.isOwner(loginUser)) {
                throw new CannotDeleteException("ë‹¤ë¥¸ ì‚¬ëŒì´ ì“´ ë‹µë³€ì´ ìˆì–´ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
        }

        List<DeleteHistory> deleteHistories = new ArrayList<>();
        question.setDeleted(true);
        deleteHistories.add(new DeleteHistory(ContentType.QUESTION, questionId, question.getWriter(), LocalDateTime.now()));
        for (Answer answer : answers) {
            answer.setDeleted(true);
            deleteHistories.add(new DeleteHistory(ContentType.ANSWER, answer.getId(), answer.getWriter(), LocalDateTime.now()));
        }
        deleteHistoryService.saveAll(deleteHistories);
    }
}
```
### íŒíŠ¸
- ê°ì²´ì˜ ìƒíƒœ ë°ì´í„°ë¥¼ êº¼ë‚´ì§€(get)ë§ê³  ë©”ì‹œì§€ë¥¼ ë³´ë‚¸ë‹¤.
- ê·œì¹™ 8: ì¼ê¸‰ ì½œë ‰ì…˜ì„ ì“´ë‹¤.
	- Questionì˜ Listë¥¼ ì¼ê¸‰ ì½œë ‰ì…˜ìœ¼ë¡œ êµ¬í˜„í•´ ë³¸ë‹¤.
- ê·œì¹™ 7: 3ê°œ ì´ìƒì˜ ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ë¥¼ ê°€ì§„ í´ë˜ìŠ¤ë¥¼ ì“°ì§€ ì•ŠëŠ”ë‹¤.
	- ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ì˜ ìˆ˜ë¥¼ ì¤„ì´ê¸° ìœ„í•´ ë„ì „í•œë‹¤.
- í…ŒìŠ¤íŠ¸í•˜ê¸° ì‰¬ìš´ ë¶€ë¶„ê³¼ í…ŒìŠ¤íŠ¸í•˜ê¸° ì–´ë ¤ìš´ ë¶€ë¶„ì„ ë¶„ë¦¬í•´ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•œ ë¶€ë¶„ë§Œ ë‹¨ìœ„í…ŒìŠ¤íŠ¸í•œë‹¤.

### TODO
- [x] Apply Previous step feedback
- [x] QnAì„œë¹„ìŠ¤ ì¤‘ í…ŒìŠ¤íŠ¸í•˜ê¸° ì–´ë ¤ìš´ ë¶€ë¶„ Question ë¡œì§ìœ¼ë¡œ ë¶„ë¦¬
- [x] Question deleteë¡œì§ êµ¬í˜„
- [x] Answer deleteë¡œì§ êµ¬í˜„
- [x] Answers 1ê¸‰ ì»¬ë ‰ì…˜ ì‘ì„±
- [x] QnAì„œë¹„ìŠ¤ ì˜í–¥ ì—†ëŠ”ì§€ í™•ì¸
- [x] Question Test ì‘ì„±
- [x] Answer Test ì‘ì„±
- [x] Answers Test ì‘ì„±
- [x] ë¬´í•œë£¨í”„ ê±¸ë¦¬ëŠ” ê³³ ìˆëŠ”ì§€ í™•ì¸(toString(), ìƒì„±ì, lombok)
- [x] Double check Answers JPA annotations

---
### Note
* JPAëŠ”, IDê¸°ë°˜.
* JPAëŠ”, Dynamic Proxyê¸°ë°˜?ìœ¼ë¡œ ìƒì„±í•˜ê¸°ì—, default constructorí•„ìš”.
* CLOB = Character Large OBject
* @DataJpaTest
	* For DB layer slicing test
	* JPAì™€ ê´€ë ¨ëœ ë¹ˆë“¤ë§Œ ì´ˆê¸°í™” í•´ì¤€ë‹¤
	* @Txê°€ ê±¸ë ¤ìˆì–´, í…ŒìŠ¤íŠ¸ ëë‚  ë•Œë§ˆë‹¤ ë¡¤ë°± ì§€ì›
* JPA repo save()í•œ ê°’ì„ ì¨ë¼.
	* Use the returned instance for further operations as the save operation might have changed the entity instance completely.
* @CreatedDate, You dont have to set value manually .
* ErrorMessageëŠ” Enumìœ¼ë¡œ ê´€ë¦¬ë„ ê°€ëŠ¥
* ì–‘ë°©í–¥ ê´€ê³„ì„¤ì •ì‹œ, ë¬´í•œë£¨í”„ ê±¸ë¦¬ì§€ ì•Šë‚˜ ë”ë¸” ì²´í¬ í•„ìš”(toString(), ìƒì„±ì, í¸ì˜ë©”ì„œë“œ)

### QnA

##### Q: JPAê°€ ì‚¬ìš©í•˜ëŠ” Proxyê¸°ìˆ ì€? GCLIB? Dynamic Proxy?

##### Q: Generation Type attributes?

##### Fixed : ë¬´ì¡°ê±´ ë‹¤ @Columnì†ì„± ì§€ì •í•´ì•¼ í•˜ë‚˜?
->  NO
```java
/**
 * Specifies the mapped column for a persistent property or field.
 * If no <code>Column</code> annotation is specified, the default values apply.
 *
 * <blockquote><pre>
 *    Example 1:
 *
 *    &#064;Column(name="DESC", nullable=false, length=512)
 *    public String getDescription() { return description; }
 *
 *    Example 2:
 *
 *    &#064;Column(name="DESC",
 *            columnDefinition="CLOB NOT NULL",
 *            table="EMP_DETAIL")
 *    &#064;Lob
 *    public String getDescription() { return description; }
 *
 *    Example 3:
 *
 *    &#064;Column(name="ORDER_COST", updatable=false, precision=12, scale=2)
 *    public BigDecimal getCost() { return cost; }
 *
 * </pre></blockquote>
 *
 *
 * @since 1.0
 */ 
```

##### Fixed : sql.TimeStamp vs Date vs LocalDateTime?
- Data : ëª¨í˜¸í•œ ì„¤ê³„ ì™€ ê°€ë³€ì„±/ ì‹œê°„ì„ MSì´ˆë¡œ í‘œí˜„ /1900ë…„ ì‹œì‘ Offset / 0ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ë‹¬ ì¸ë±ìŠ¤ / ì¤‘ì•™ìœ ëŸ½ì‹œê°„
- LocalDateTime (from Java8) : ë¶ˆë³€/ NSê¹Œì§€ í‘œí˜„ê°€ëŠ¥ /. No Offset / 1ë¡œ ì‹œì‘í•˜ëŠ” ë‹¬ ì¸ë±ìŠ¤
- TimeStamp : NSê¹Œì§€ í‘œí˜„ ê°€ëŠ¥

##### Q: How to set Unique Constraints in JPA?
- Unique key is a set of single or multiple columns of a table that uniquely identify a record in a database table
- JPA allows us to define unique constraints in our code using 
- Column Constraints -> @Column(unique=true) 
- Table Constraints -> @UniqueConstraint. 
- Refer : https://www.baeldung.com/jpa-unique-constraints

##### Fixed : JPA Buddy plug inìœ¼ë¡œ ë¬´ì—‡ì´ ê°€ëŠ¥í•œì§€?
- Refer : https://www.jpa-buddy.com/?utm_source=baeldung&utm_medium=display&utm_campaign=npi

##### Q : 	BaseTimeEntityë¥¼ ìƒì†í•œ ì—”í‹°í‹°í´ë˜ìŠ¤ì—ì„œ, Super ìƒì„±ìë¥¼ ë¶€ë¥´ì§€ ì•ŠëŠ”ë°,  ì–´ë–»ê²Œ ì»´íŒŒì¼ì´ ë˜ëŠ”ê±´ì§€? @MappedSuperclass ë™ì‘ í™•ì¸

##### Fixed : Entityì˜ ID í•„ë“œë¥¼ ë…¼ë¦¬ ë™ì¹˜ì„±(ë™ë“±ì„±) ê³„ì‚°ì‹œ í¬í•¨í•´ì•¼ í•˜ë‚˜?
- ë§Œì•½ í¬í•¨í•œë‹¤ë©´, DBë³´ì¡´ ì „í›„ë¡œ, equals()ë¥¼ í†µí•œ ë™ë“±ì„± ê³„ì‚°ì— ì‹¤íŒ¨í•˜ê²Œ ëœë‹¤.
	- ê°œì²´ ìƒì„±ì‹œ IDê°€ ì¡´ì¬ í•˜ì§€ ì•ŠëŠ” ê°œì²´ëŠ” , JPAí†µí•´ saveí›„ì—ëŠ” IDê°€ ì¡´ì¬í•˜ê²Œ ë˜ë¯€ë¡œ.
	- ê²°ë¡  : PKë¥¼ ê°€ì§€ê³  êµ¬í˜„. ì´ ê²½ìš° ì˜ì†í™”ë˜ê¸° ì „ì˜ ê°ì²´ëŠ”  equals, hashcode ê°€ ì œëŒ€ë¡œ ë™ì‘í•˜ì§€ ì•Šì„ ê°€ëŠ¥ì„±ì´ ìˆì§€ë§Œ, ì»¨ë²¤ì…˜ì„ í†µí•´ ë³´ì™„í•˜ê¸°.

##### Q : saveì „í›„ë¡œ ì°¸ì¡° ìš”ì†Œê°€ ë‹¬ë¼ì§€ëŠ”ê±´, IDì†ì„±ì´ NULLì¼ë•Œë§Œ ì•„ë‹ˆì—ˆë‚˜? 


##### Q : LAZYì˜ ì„±ëŠ¥ ì´ì  ì´ì™¸ì˜ Prosê³¼ Consideration
- LazyInitializationException, N+1 query, fetch join, @BatchSize, entity graph í‚¤ì›Œë“œë¥¼ ìˆœì„œëŒ€ë¡œ ì°¾ì•„ì„œ í•™ìŠµ
- ê³ ë ¤Case : LAZYë¡œ ì—°ê´€ê´€ê³„ê°€ ì„¤ì •ëœ ê°ì²´ë¥¼, íŠ¸ëœì­ì…˜ ë²”ìœ„ ë°–(ì»¤ë„¥ì…˜ì´ ì—†ëŠ” ìƒíƒœ)ì—ì„œ toString ì´ í˜¸ì¶œí•  ê²½ìš° ìƒê¸°ëŠ” ë¬¸ì œ

##### Fixed : Canâ€™t connect to H2 v2.1.214 from IntelliJ
- Cause : IntelliJ tries to fetch the table names, using the statement
SELECT CATALOG_NAME FROM INFORMATION_SCHEMA.CATALOGS
which is only supported for H2 1.4.200 and older.
- Solution : As workaround to use IntelliJ with newer H2 drivers the old behavior can be activated by adding OLD_INFORMATION_SCHEMA=TRUE to the connect string.
- Refer : https://github.com/JetBrains/jetbrains_guide/issues/215

##### Fixed : 42001 Syntax error when create table user
- Cause : Needed to add Identifier
- ASIS : ```create table user```
- TOBE : ```create table "USER"```


