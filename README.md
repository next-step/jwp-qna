# JPA HandsOn

## 🚀 1단계 - 엔티티 매핑

### Goal

QnA 서비스를 만들어가면서 JPA로 실제 도메인 모델을 어떻게 구성하고 객체와 테이블을 어떻게 매핑해야 하는지 알아본다.

### Requirements

* 아래의 DDL(Data Definition Language)을 보고 유추하여 엔티티 클래스와 리포지토리 클래스를 작성해 본다.
* @DataJpaTest를 사용하여 학습 테스트를 해 본다.

```sql
create table answer
(
    id          bigint generated by default as identity,
    contents    clob,
    created_at  timestamp not null,
    deleted     boolean   not null,
    question_id bigint,
    updated_at  timestamp,
    writer_id   bigint,
    primary key (id)
)

create table delete_history
(
    id            bigint generated by default as identity,
    content_id    bigint,
    content_type  varchar(255),
    create_date   timestamp,
    deleted_by_id bigint,
    primary key (id)
)

create table question
(
    id         bigint generated by default as identity,
    contents   clob,
    created_at timestamp    not null,
    deleted    boolean      not null,
    title      varchar(100) not null,
    updated_at timestamp,
    writer_id  bigint,
    primary key (id)
)

create table user
(
    id         bigint generated by default as identity,
    created_at timestamp   not null,
    email      varchar(50),
    name       varchar(20) not null,
    password   varchar(20) not null,
    updated_at timestamp,
    user_id    varchar(20) not null,
    primary key (id)
)

alter table user
    add constraint UK_a3imlf41l37utmxiquukk8ajc unique (user_id)


```

### TODO
- [x] JPA Auditing Entity
- [x] Enable JPA Audit in Application 
- [ ] Answer Entity
- [ ] Answer Test (CRUD)
- [ ] DeleteHistory Entity
- [ ] DeleteHistory Test(CRUD)
- [ ] Question Entity
- [ ] Question Test(CRUD)
- [x] User Entity
	- [x] 스키마에 맞게 어노테이션 추가
	- [x] 불필요한 setter 삭제
	- [x] equals / hashCode 추가
		- [x] core fields = id, userId
- [x] User Entity Test (CRUD)

### Hints

Spring Data JPA 사용 시 아래 옵션은 동작 쿼리를 로그로 확인할 수 있게 해준다.

```
spring.jpa.properties.hibernate.format_sql=true
spring.jpa.show-sql=true
```


### Note

* JPA는, ID기반.
* JPA는, Dynamic Proxy기반?으로 생성하기에, default constructor필요.
* CLOB = Character Large OBject
* @DataJpaTest
	* For DB layer slicing test
	* JPA와 관련된 빈들만 초기화 해준다
	* @Tx가 걸려있어, 테스트 끝날 때마다 롤백 지원
* JPA repo save()한 값을 써라.
	* Use the returned instance for further operations as the save operation might have changed the entity instance completely.
* @CreatedDate, You dont have to set value manually .

### QnA

##### Q: JPA가 사용하는 Proxy기술은? GCLIB? Dynamic Proxy?

##### Q: Generation Type attributes?

##### Q: 무조건 다 @Column속성 지정해야 하나?
->  NO
```java
/**
 * Specifies the mapped column for a persistent property or field.
 * If no <code>Column</code> annotation is specified, the default values apply.
 *
 * <blockquote><pre>
 *    Example 1:
 *
 *    &#064;Column(name="DESC", nullable=false, length=512)
 *    public String getDescription() { return description; }
 *
 *    Example 2:
 *
 *    &#064;Column(name="DESC",
 *            columnDefinition="CLOB NOT NULL",
 *            table="EMP_DETAIL")
 *    &#064;Lob
 *    public String getDescription() { return description; }
 *
 *    Example 3:
 *
 *    &#064;Column(name="ORDER_COST", updatable=false, precision=12, scale=2)
 *    public BigDecimal getCost() { return cost; }
 *
 * </pre></blockquote>
 *
 *
 * @since 1.0
 */ 
```

##### Q : sql.TimeStamp vs Date vs LocalDateTime?
- Data : 모호한 설계 와 가변성/ 시간을 MS초로 표현 /1900년 시작 Offset / 0으로 시작하는 달 인덱스 / 중앙유럽시간
- LocalDateTime (from Java8) : 불변/ NS까지 표현가능 /. No Offset / 1로 시작하는 달 인덱스
- TimeStamp : NS까지 표현 가능


##### Q: How to set Unique Constraints in JPA?
- Unique key is a set of single or multiple columns of a table that uniquely identify a record in a database table
- JPA allows us to define unique constraints in our code using 
- Column Constraints -> @Column(unique=true) 
- Table Constraints -> @UniqueConstraint. 
- Refer : https://www.baeldung.com/jpa-unique-constraints

##### Q : JPA Buddy plug in으로 무엇이 가능한지?
- Refer : https://www.jpa-buddy.com/?utm_source=baeldung&utm_medium=display&utm_campaign=npi

##### Q : 	BaseTimeEntity를 상속한 엔티티클래스에서, Super 생성자를 부르지 않는데,  어떻게 컴파일이 되는건지? @MappedSuperclass 동작 확인

##### Q : Entity의 ID 필드를 논리 동치성(동등성) 계산시 포함해야 하나?
- 만약 포함한다면, DB보존 전후로, equals()를 통한 동등성 계산에 실패하게 된다.
	- 개체 생성시 ID가 존재 하지 않는 개체는 , JPA통해 save후에는 ID가 존재하게 되므로.
	- 이게 맞나?
	- 굳이 지금 요구사항을 모르는데, 섣부르게 동등성 판단을 하려고 하는게 아닌가?
	- Step1에서는 동등성 계산 보류.

Q : save전후로 참조 요소가 달라지는건, ID속성이 NULL일때만 아니었나? 
